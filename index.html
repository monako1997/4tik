<script>
  // اجلب عناصر الواجهة حسب IDs الموجودة عندك
  const drop = document.getElementById('drop');
  const fileInput = document.getElementById('file');
  const info = document.getElementById('fileInfo');
  const processBtn = document.getElementById('process');
  const bar = document.getElementById('bar');
  const status = document.getElementById('status');

  // مفتاح الاشتراك: يُطلب مرة ويُخزن محليًا
  function getKey() {
    let k = localStorage.getItem('SUB_KEY');
    if (!k) {
      k = prompt('أدخل مفتاح الاشتراك');  // غيّر النص لو تحب
      if (!k) return null;
      localStorage.setItem('SUB_KEY', k.trim());
    }
    return k;
  }

  // توليد بصمة جهاز مبسطة وتخزينها
  async function sha256(text){
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    const arr = Array.from(new Uint8Array(buf));
    return arr.map(b => b.toString(16).padStart(2,'0')).join('');
  }
  async function getDeviceHash(){
    let d = localStorage.getItem('DEVICE_HASH');
    if (!d) {
      const seed = [
        navigator.userAgent,
        navigator.language,
        screen.width+'x'+screen.height,
        navigator.platform,
        Intl.DateTimeFormat().resolvedOptions().timeZone,
        Math.random().toString(36).slice(2)
      ].join('|');
      d = await sha256(seed);
      localStorage.setItem('DEVICE_HASH', d);
    }
    return d;
  }

  // أدوات مساعدة
  const mb = n => (n/1024/1024).toFixed(2)+' MB';
  function startDots(){ status.innerHTML = 'جارٍ تحسين الفيديو <span class="dots"><i></i><i></i><i></i></span>'; }
  function stopDots(){ status.textContent=''; }

  // سحب/إفلات واختيار ملف
  drop?.addEventListener('click', () => fileInput?.click());
  drop?.addEventListener('dragover', e => { e.preventDefault(); });
  drop?.addEventListener('drop', e => { e.preventDefault(); if(e.dataTransfer.files.length){ fileInput.files = e.dataTransfer.files; updateInfo(); }});
  fileInput?.addEventListener('change', updateInfo);

  function updateInfo(){
    const f = fileInput.files[0];
    if(!f){ if(info){ info.textContent='اسحب المقطع هنا أو اضغط للاختيار'; } processBtn.disabled=true; return; }
    if(info){ info.textContent = `الملف: ${f.name} — ${mb(f.size)}`; }
    processBtn.disabled = false;
  }

  // معالجة
  processBtn?.addEventListener('click', async () => {
    const f = fileInput.files[0]; if(!f) return;

    const key = getKey();
    if (!key) { alert('المفتاح مطلوب'); return; }
    const device = await getDeviceHash();

    // فحص سريع قبل الرفع (اختياري)
    try{
      const pre = await fetch('/check', {method:'POST', headers: {'X-KEY': key, 'X-DEVICE': device}});
      const pj = await pre.json();
      if (!pre.ok || !pj.ok){
        status.textContent = pj.msg || 'المفتاح مرفوض';
        if (pre.status === 401) localStorage.removeItem('SUB_KEY');
        return;
      }
    }catch{}

    status.textContent = 'جارٍ الرفع…';
    bar?.classList.remove('running'); if(bar) bar.style.width='0%';

    const fd = new FormData(); fd.append('file', f);
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/process', true);
    xhr.responseType = 'blob';

    // إرسال الهيدرات للمفتاح والجهاز
    xhr.setRequestHeader('X-KEY', key);
    xhr.setRequestHeader('X-DEVICE', device);

    xhr.upload.onprogress = e => { if(e.lengthComputable && bar){ bar.style.width = Math.round((e.loaded/e.total)*100) + '%'; } };
    xhr.onreadystatechange = () => { if (xhr.readyState === XMLHttpRequest.HEADERS_RECEIVED){ startDots(); bar?.classList.add('running'); } };

    xhr.onload = () => {
      bar?.classList.remove('running'); stopDots();
      if (xhr.status === 200) {
        status.textContent = 'تمّت المعالجة — يبدأ التنزيل الآن';
        const blob = xhr.response, url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'output.mp4'; document.body.appendChild(a); a.click();
        URL.revokeObjectURL(url); a.remove();
      } else {
        const reader = new FileReader();
        reader.onload = () => { status.textContent = reader.result || 'حدث خطأ، حاول مجددًا.'; };
        reader.readAsText(xhr.response);
        if (xhr.status === 401) localStorage.removeItem('SUB_KEY');
      }
    };
    xhr.onerror = () => { bar?.classList.remove('running'); status.textContent = 'تعذّر الاتصال.'; };
    xhr.send(fd);
  });
</script>