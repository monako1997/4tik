<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>4Tik Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0a0b12;--ink:#f3f6fb;--muted:#aab6c5;--line:#1d2433;--c1:#25F4EE;--c2:#FE2C55;}
    *{box-sizing:border-box;font-family:'Cairo',sans-serif}
    body{margin:0;min-height:100vh;display:flex;flex-direction:column;align-items:center;color:var(--ink);
      background:radial-gradient(800px 400px at 15% -10%, rgba(37,244,238,.12), transparent 60%),
                 radial-gradient(900px 500px at 110% -20%, rgba(254,44,85,.12), transparent 60%),
                 linear-gradient(180deg,#080910 0%, #0a0b12 100%);}
    .topbar{position:sticky;top:0;width:100%;display:flex;justify-content:center;align-items:center;padding:14px 16px;
      backdrop-filter:saturate(140%) blur(6px);background:linear-gradient(180deg, rgba(10,11,18,.65), rgba(10,11,18,0));z-index:10;}
    .brand{font-weight:900;font-size:42px;letter-spacing:.6px;margin:0;background:linear-gradient(90deg,var(--c2),var(--c1),var(--c2));
      -webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 18px rgba(37,244,238,.35),0 0 18px rgba(254,44,85,.25);
      background-size:200% auto;animation:shine 3s linear infinite;}
    @keyframes shine { to { background-position:-200% center; } }

    .wrap{width:min(900px,96vw); padding:20px 16px 160px;}
    .card{background:#0f1320;border:1px solid var(--line);border-radius:16px;padding:22px;box-shadow:0 20px 60px rgba(0,0,0,.35);margin-bottom:14px}
    .upload{position:relative;border-radius:16px;padding:28px;text-align:center;cursor:pointer;background:rgba(255,255,255,.02);
      border:2px dashed #314055;overflow:hidden;isolation:isolate}
    .upload::before{content:"";position:absolute;inset:-2px;z-index:-1;border-radius:18px;
      background:conic-gradient(from 0deg,var(--c1),var(--c2),var(--c1));filter:blur(14px);opacity:.45}
    .u-title{display:inline-block;font-weight:800;font-size:22px;text-transform:uppercase;background:linear-gradient(90deg,var(--c1),var(--c2));
      -webkit-background-clip:text;background-clip:text;color:transparent}
    .hint{margin-top:6px;color:var(--muted);font-size:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:14px}
    button{padding:12px 22px;border:0;border-radius:12px;font-weight:700;cursor:pointer;font-size:16px;
      background:linear-gradient(90deg,var(--c2),var(--c1));color:#0a0b12;box-shadow:0 8px 24px rgba(37,244,238,.18),0 8px 24px rgba(254,44,85,.16)}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .bar-wrap{height:14px;background:#0a0f1a;border:1px solid var(--line);border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0%;border-radius:999px;background:linear-gradient(90deg,var(--c2),var(--c1));transition:width .12s}
    .bar.running{animation:slide 1.1s linear infinite;background:linear-gradient(90deg,transparent 0%,rgba(255,255,255,.15) 50%,transparent 100%);width:40%}
    @keyframes slide{from{margin-inline-start:-40%}to{margin-inline-start:100%}}
    .status{font-size:14px;color:var(--muted)}
    .footer{position:fixed;bottom:15px;left:0;right:0;text-align:center;font-size:18px;font-weight:700;color:var(--ink);
      display:flex;justify-content:center;align-items:center;gap:10px;z-index:20}
    .heart{color:var(--c2);font-size:20px;animation:beat 1s infinite}
    @keyframes beat{0%,20%,40%,60%,80%,100%{transform:scale(1)}10%,30%,50%,70%,90%{transform:scale(1.3)}}
    ul.guide{padding:0 20px;margin:0;line-height:1.8}
    ul.guide li{margin-bottom:6px;color:var(--muted)}
  </style>
</head>
<body>
  <header class="topbar"><h1 class="brand">4Tik Pro</h1></header>

  <main class="wrap">
    <!-- رفع -->
    <section class="card">
      <div id="drop" class="upload">
        <input id="file" type="file" accept="video/*" hidden />
        <div class="u-title">upload video</div>
        <div id="fileInfo" class="hint">اسحب المقطع هنا أو اضغط للاختيار</div>
      </div>
      <div class="row">
        <button id="process" disabled>معالجة</button>
        <div id="status" class="status" style="margin-inline-start:auto"></div>
      </div>
      <div class="bar-wrap" style="margin-top:12px"><div id="bar" class="bar"></div></div>
    </section>

    <!-- اشتراك -->
    <section class="card">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <button id="showSub">عرض اشتراكي</button>
        <button id="copyKey" style="background:#fff;color:#0a0b12">نسخ مفتاحي</button>
        <div id="subToast" style="font-size:13px;color:#aab6c5"></div>
      </div>
      <div style="margin-top:10px;line-height:1.9">
        <div>المفتاح: <b id="subKey">—</b></div>
        <div>ينتهي في: <b id="subExp">—</b></div>
        <div>الأيام المتبقية: <b id="subDays">—</b></div>
        <div>حالة الربط: <b id="subBind">—</b></div>
        <div>آخر استخدام: <b id="subLast">—</b></div>
      </div>
    </section>

    <!-- تعليمات -->
    <section class="card">
      <h3 style="margin-top:0;color:var(--c1)">📌 تعليمات مهمة</h3>
      <ul class="guide">
        <li>الحد الأقصى لحجم ملف الفيديو: <b>100 ميقا</b>.</li>
        <li>بعد اكتمال معالجة الفيديو وتنزيله، افتح تطبيق <b>TikTok</b> وارفع الفيديو كـ<strong>خاص</strong>.</li>
        <li>بعد اكتمال الرفع، يمكنك تغييره من خاص إلى <strong>عام</strong>.</li>
      </ul>
    </section>
  </main>

  <div class="footer">Made by Manal <span class="heart">❤</span></div>

  <script>
    // عناصر
    const drop = document.getElementById('drop');
    const fileInput = document.getElementById('file');
    const info = document.getElementById('fileInfo');
    const processBtn = document.getElementById('process');
    const bar = document.getElementById('bar');
    const status = document.getElementById('status');
    const showSubBtn = document.getElementById('showSub');
    const copyKeyBtn = document.getElementById('copyKey');
    const subKey = document.getElementById('subKey');
    const subExp = document.getElementById('subExp');
    const subDays = document.getElementById('subDays');
    const subBind = document.getElementById('subBind');
    const subLast = document.getElementById('subLast');
    const subToast = document.getElementById('subToast');
    const mb = n => (n/1024/1024).toFixed(2)+' MB';

    // ======== أدوات هاش عامة ========
    async function sha256(text){
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      const arr = Array.from(new Uint8Array(buf));
      return arr.map(b => b.toString(16).padStart(2,'0')).join('');
    }

    // ======== بصمة قوية: Hardware + Canvas + WebGL ========
    function canvasFingerprint(){
      try{
        const c = document.createElement('canvas');
        c.width = 200; c.height = 60;
        const g = c.getContext('2d');
        g.textBaseline = 'top';
        g.font = '16px Arial';
        g.fillStyle = '#f60';
        g.fillRect(0,0,200,30);
        g.fillStyle = '#069';
        g.fillText('4TikPro-fp', 2, 2);
        g.strokeStyle = '#f00';
        g.arc(100,30,20,0,Math.PI*2); g.stroke();
        return c.toDataURL();
      }catch{ return 'no-canvas'; }
    }

    function webglInfo(){
      try{
        const c = document.createElement('canvas');
        const gl = c.getContext('webgl') || c.getContext('experimental-webgl');
        if(!gl) return 'no-webgl';
        const dbg = gl.getExtension('WEBGL_debug_renderer_info');
        const vendor = dbg ? gl.getParameter(dbg.UNMASKED_VENDOR_WEBGL) : 'v?';
        const renderer = dbg ? gl.getParameter(dbg.UNMASKED_RENDERER_WEBGL) : 'r?';
        return vendor + '|' + renderer;
      }catch{ return 'no-webgl'; }
    }

    async function getDeviceHash(){
      const seedParts = [
        // عتاد/نظام (أكثر ثباتًا عبر المتصفحات)
        navigator.platform || 'pf?',
        (screen.width||0)+'x'+(screen.height||0),
        window.devicePixelRatio || 1,
        navigator.hardwareConcurrency || 'hc?',
        navigator.deviceMemory || 'dm?',
        navigator.maxTouchPoints || 0,
        Intl.DateTimeFormat().resolvedOptions().timeZone || 'tz?',
        // بصمات إضافية
        canvasFingerprint(),
        webglInfo()
      ];
      const seed = seedParts.join('|');
      return await sha256(seed);
    }

    // ======== المفتاح: أول مرة فقط، بعد الربط يمكن بالجهاز ========
    async function getKey(autoCheck = false) {
      let k = localStorage.getItem('SUB_KEY');
      if (k) return k;

      if (autoCheck) {
        const device = await getDeviceHash();
        try {
          const res = await fetch('/check', { method:'POST', headers: { 'X-DEVICE': device } });
          const data = await res.json();
          if (res.ok && data.ok) {
            return "__DEVICE_ONLY__"; // الجهاز معروف مسبقًا
          }
        } catch(e) {}
      }

      k = prompt('أدخل مفتاح الاشتراك');
      if (!k) return null;
      localStorage.setItem('SUB_KEY', k.trim());
      return k;
    }

    // ======== تحديث معلومات الملف ========
    function updateInfo(){
      const f = fileInput.files[0];
      status.textContent='';
      if(!f){ info.textContent='اسحب المقطع هنا أو اضغط للاختيار'; processBtn.disabled=true; return; }
      info.textContent = `الملف: ${f.name} — ${mb(f.size)}`;
      processBtn.disabled = false;
    }

    drop.addEventListener('click', () => fileInput.click());
    drop.addEventListener('dragover', e => e.preventDefault());
    drop.addEventListener('drop', e => { e.preventDefault(); if(e.dataTransfer.files.length){ fileInput.files = e.dataTransfer.files; updateInfo(); }});
    fileInput.addEventListener('change', updateInfo);

    // ======== معالجة ========
    processBtn.addEventListener('click', async () => {
      const f = fileInput.files[0]; if(!f) return;
      const key = await getKey(true); if (!key) { alert('المفتاح مطلوب'); return; }
      const device = await getDeviceHash();

      status.textContent = 'جارٍ الرفع…';
      bar.classList.remove('running'); bar.style.width='0%';
      processBtn.disabled = true; fileInput.disabled = true; drop.style.pointerEvents='none'; drop.style.opacity='0.5';

      const fd = new FormData(); fd.append('file', f);
      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/process', true);
      xhr.responseType = 'blob';

      if (key !== "__DEVICE_ONLY__") xhr.setRequestHeader('X-KEY', key);
      xhr.setRequestHeader('X-DEVICE', device);

      xhr.upload.onprogress = e => { if(e.lengthComputable){ bar.style.width = Math.round((e.loaded/e.total)*100) + '%'; } };
      xhr.onreadystatechange = () => { if (xhr.readyState === XMLHttpRequest.HEADERS_RECEIVED){ status.textContent='جارٍ تحسين الفيديو…'; bar.classList.add('running'); } };

      xhr.onload = () => {
        bar.classList.remove('running');
        if (xhr.status === 200) {
          status.textContent = 'تمّت المعالجة — يبدأ التنزيل الآن';
          const blob = xhr.response, url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = url; a.download = 'output.mp4'; document.body.appendChild(a); a.click();
          URL.revokeObjectURL(url); a.remove();
          setTimeout(() => { drop.style.pointerEvents='auto'; drop.style.opacity='1'; fileInput.disabled=false; fileInput.value=''; updateInfo(); }, 800);
        } else {
          const reader = new FileReader();
          reader.onload = () => { status.textContent = reader.result || 'حدث خطأ، حاول مجددًا.'; };
          reader.readAsText(xhr.response);
          drop.style.pointerEvents='auto'; drop.style.opacity='1'; fileInput.disabled=false; updateInfo();
          if (xhr.status === 401) localStorage.removeItem('SUB_KEY');
        }
      };
      xhr.onerror = () => { bar.classList.remove('running'); status.textContent='تعذّر الاتصال.'; drop.style.pointerEvents='auto'; drop.style.opacity='1'; fileInput.disabled=false; updateInfo(); };
      xhr.send(fd);
    });

    // ======== صندوق الاشتراك ========
    async function refreshSubscriptionBox(auto=false){
      try{
        const key = await getKey(true);
        if (!key) { if(!auto) alert('أدخل مفتاح الاشتراك أولاً'); return; }
        const device = await getDeviceHash();
        const headers = { 'X-DEVICE': device };
        if (key !== "__DEVICE_ONLY__") headers['X-KEY'] = key;
        const res = await fetch('/me', { headers });
        const data = await res.json();

        if (!res.ok) {
          subKey.textContent = '—';
          subExp.textContent = '—';
          subDays.textContent = '—';
          subBind.textContent = data.error || 'غير متوفر';
          subLast.textContent = '—';
          return;
        }

        // عرض المفتاح محليًا إن وُجد (أوضح من *** القادمة من السيرفر)
        let displayKey = data.key_masked || '—';
        const localKey = localStorage.getItem('SUB_KEY');
        if (localKey && localKey !== "__DEVICE_ONLY__") {
          displayKey = localKey.substring(0,4) + "****" + localKey.slice(-4);
        }
        subKey.textContent = displayKey;

        subExp.textContent = data.expires || '—';
        subDays.textContent = (data.days_left ?? '—');
        if (data.bound === false) subBind.textContent = 'غير مربوط بعد';
        else subBind.textContent = data.bound_to_this_device ? 'مربوط بهذا الجهاز' : 'مربوط بجهاز آخر';
        subLast.textContent = data.last_used ? data.last_used : '—';

        if(!auto){
          subToast.textContent = '✅ تم تحديث معلومات الاشتراك';
          setTimeout(()=> subToast.textContent = '', 2000);
        }
      }catch(e){
        subToast.textContent = 'تعذر جلب معلومات الاشتراك';
        setTimeout(()=> subToast.textContent = '', 2000);
      }
    }

    showSubBtn?.addEventListener('click', ()=> refreshSubscriptionBox(false));
    copyKeyBtn?.addEventListener('click', async ()=>{
      const key = localStorage.getItem('SUB_KEY');
      if (!key) { alert('لا يوجد مفتاح محفوظ بعد.'); return; }
      try{
        await navigator.clipboard.writeText(key);
        subToast.textContent = '📋 تم نسخ المفتاح';
        setTimeout(()=> subToast.textContent = '', 2000);
      }catch{
        subToast.textContent = 'تعذر النسخ، انسخه يدويًا.';
        setTimeout(()=> subToast.textContent = '', 2000);
      }
    });

    // تحديث تلقائي عند فتح الصفحة
    window.addEventListener('load', ()=> {
      refreshSubscriptionBox(true);
    });
  </script>
</body>
</html>