<script>
// ===== إضافة بسيطة للمنع من الواجهة عبر السيرفر =====
async function checkServerQuota() {
  try {
    const r = await fetch('/quota-status', {cache: 'no-store'});
    const data = await r.json();
    if (data.allowed === false) {
      // قفل الرفع والزر مع رسالة واضحة
      drop.style.pointerEvents = 'none';
      drop.style.opacity = '0.5';
      fileInput.disabled = true;
      processBtn.disabled = true;
      info.textContent = data.message || "تم استخدام فرصة اليوم لهذا الجهاز.";
      status.textContent = "";
      return false;
    }
    // مسموح اليوم
    drop.style.pointerEvents = 'auto';
    drop.style.opacity = '1';
    fileInput.disabled = false;
    processBtn.disabled = true; // لا نفعّله إلا بعد اختيار ملف
    return true;
  } catch(e){
    // لو فشل الاستعلام، نسمح مؤقتًا (اختياري) أو نعرض رسالة
    return true;
  }
}

// استدعِ الفحص عند فتح الصفحة
document.addEventListener('DOMContentLoaded', checkServerQuota);

// تأكيد المنع أيضًا عند الضغط على "Process"
const _origOnClick = processBtn.onclick;
processBtn.addEventListener('click', async (ev) => {
  // إذا السيرفر يقول ممنوع، نوقف
  const allowed = await checkServerQuota();
  if (!allowed) { ev.preventDefault(); return; }
});

// التعامل مع ردّ 429 أثناء الرفع (لو صار)
(function patchXhrFor429(){
  const origOpen = XMLHttpRequest.prototype.open;
  XMLHttpRequest.prototype.open = function(method, url){
    this.addEventListener('load', function(){
      if (this.status === 429) {
        // منع لاحق اليوم
        drop.style.pointerEvents = 'none';
        drop.style.opacity = '0.5';
        fileInput.disabled = true;
        processBtn.disabled = true;
        bar.classList.remove('running');
        status.textContent = "";
        info.textContent = "تم استخدام فرصة اليوم لهذا الجهاز. يرجى المحاولة غدًا.";
      }
    });
    return origOpen.apply(this, arguments);
  };
})();
</script>