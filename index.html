<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>4Tik Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0a0b12;--ink:#f3f6fb;--muted:#aab6c5;--line:#1d2433;--c1:#25F4EE;--c2:#FE2C55;}
    *{box-sizing:border-box;font-family:'Cairo',sans-serif}
    body{margin:0;min-height:100vh;display:flex;flex-direction:column;align-items:center;color:var(--ink);
      background:linear-gradient(180deg,#080910 0%,#0a0b12 100%);}
    .topbar{position:sticky;top:0;width:100%;text-align:center;padding:14px;background:#0f1320;z-index:10}
    .brand{font-weight:900;font-size:34px;background:linear-gradient(90deg,var(--c2),var(--c1));
      -webkit-background-clip:text;background-clip:text;color:transparent}
    .wrap{width:min(800px,95%);padding:20px 16px 120px}
    .card{background:#0f1320;border:1px solid var(--line);border-radius:16px;padding:20px;margin-bottom:16px}
    .upload{border:2px dashed #314055;border-radius:16px;padding:30px;text-align:center;cursor:pointer}
    .u-title{font-weight:700;font-size:18px;color:var(--c1)}
    .hint{margin-top:6px;color:var(--muted);font-size:14px}
    .row{display:flex;gap:10px;align-items:center;margin-top:14px;flex-wrap:wrap}
    button{padding:10px 20px;border:0;border-radius:10px;font-weight:700;cursor:pointer;
      background:linear-gradient(90deg,var(--c2),var(--c1));color:#0a0b12}
    .bar-wrap{height:12px;background:#0a0f1a;border:1px solid var(--line);border-radius:999px;overflow:hidden;margin-top:10px}
    .bar{height:100%;width:0;background:linear-gradient(90deg,var(--c2),var(--c1));transition:width .2s}
    .footer{position:fixed;bottom:10px;left:0;right:0;text-align:center;font-size:16px;color:var(--ink)}
    .heart{color:var(--c2);animation:beat 1s infinite}
    @keyframes beat{0%,20%,40%,60%,80%,100%{transform:scale(1)}10%,30%,50%,70%,90%{transform:scale(1.3)}}
    /* Ù…ÙˆØ¯Ø§Ù„ */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;justify-content:center;align-items:center;z-index:999}
    .modal-box{background:#0f1320;padding:20px;border-radius:12px;width:300px;text-align:center}
    .modal-box input{width:100%;padding:10px;border-radius:8px;border:1px solid var(--line);margin-bottom:12px}
  </style>
</head>
<body>
  <header class="topbar"><h1 class="brand">4Tik Pro</h1></header>

  <main class="wrap">
    <section class="card">
      <div id="drop" class="upload">
        <input id="file" type="file" accept="video/*" hidden>
        <div class="u-title">ğŸ“¤ Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</div>
        <div id="fileInfo" class="hint">Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</div>
      </div>
      <div class="row">
        <button id="process" disabled>Ù…Ø¹Ø§Ù„Ø¬Ø©</button>
        <div id="status" style="color:var(--muted)"></div>
      </div>
      <div class="bar-wrap"><div id="bar" class="bar"></div></div>
    </section>

    <section class="card">
      <button id="showSub">ğŸ“‹ Ø§Ø´ØªØ±Ø§ÙƒÙŠ</button>
      <div id="subBox" style="margin-top:10px;font-size:14px;color:var(--muted)"></div>
    </section>
  </main>

  <div class="footer">Made by Manal <span class="heart">â¤</span></div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ù…ÙØªØ§Ø­ -->
  <div id="modal" class="modal" style="display:none">
    <div class="modal-box">
      <h3>Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</h3>
      <input id="keyInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…ÙØªØ§Ø­ Ù‡Ù†Ø§">
      <button id="loginBtn">ØªØ£ÙƒÙŠØ¯</button>
      <div id="loginMsg" style="font-size:13px;color:var(--muted);margin-top:8px"></div>
    </div>
  </div>

  <script>
    const fileInput=document.getElementById('file');
    const drop=document.getElementById('drop');
    const info=document.getElementById('fileInfo');
    const processBtn=document.getElementById('process');
    const bar=document.getElementById('bar');
    const status=document.getElementById('status');
    const showSub=document.getElementById('showSub');
    const subBox=document.getElementById('subBox');
    const modal=document.getElementById('modal');
    const keyInput=document.getElementById('keyInput');
    const loginBtn=document.getElementById('loginBtn');
    const loginMsg=document.getElementById('loginMsg');

    // ====== ØªÙˆÙ„ÙŠØ¯ Ø¨ØµÙ…Ø© Ø¬Ù‡Ø§Ø² (Ø¨Ø³ÙŠØ·Ø©) ======
    async function sha256(text){
      const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    async function getDeviceHash(){
      const seed = navigator.userAgent + "|" + screen.width+"x"+screen.height + "|" + navigator.language;
      return await sha256(seed);
    }

    // ====== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙØªØ§Ø­ ======
    function getKey(){ return localStorage.getItem("SUB_KEY"); }
    function saveKey(k){ localStorage.setItem("SUB_KEY",k); }

    async function ensureKey(){
      let k = getKey();
      if(!k){
        modal.style.display="flex";
        return null;
      }
      return k;
    }

    loginBtn.onclick=async()=>{
      const val=keyInput.value.trim();
      if(!val){loginMsg.textContent="âš ï¸ Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­";return;}
      saveKey(val);
      modal.style.display="none";
      loginMsg.textContent="";
    }

    // ====== ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù ======
    function updateInfo(){
      const f=fileInput.files[0];
      if(!f){info.textContent="Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±";processBtn.disabled=true;return;}
      info.textContent=`${f.name} â€” ${(f.size/1024/1024).toFixed(1)}MB`;
      processBtn.disabled=false;
    }

    drop.onclick=()=>fileInput.click();
    drop.ondragover=e=>e.preventDefault();
    drop.ondrop=e=>{e.preventDefault();if(e.dataTransfer.files.length){fileInput.files=e.dataTransfer.files;updateInfo();}}
    fileInput.onchange=updateInfo;

    // ====== Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ======
    processBtn.onclick=async()=>{
      const f=fileInput.files[0]; if(!f) return;
      const key=await ensureKey(); if(!key) return;
      const device=await getDeviceHash();

      status.textContent="Ø¬Ø§Ø±Ù Ø§Ù„Ø±ÙØ¹â€¦"; bar.style.width="0";
      processBtn.disabled=true;

      const fd=new FormData(); fd.append("file",f);
      const xhr=new XMLHttpRequest();
      xhr.open("POST","/process",true);
      xhr.responseType="blob";
      xhr.setRequestHeader("X-KEY",key);
      xhr.setRequestHeader("X-DEVICE",device);
      xhr.upload.onprogress=e=>{if(e.lengthComputable){bar.style.width=Math.round((e.loaded/e.total)*100)+"%";}};
      xhr.onload=()=>{
        if(xhr.status===200){
          status.textContent="ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© âœ…";
          const url=URL.createObjectURL(xhr.response);
          const a=document.createElement("a");a.href=url;a.download="output.mp4";a.click();
          URL.revokeObjectURL(url);
        }else{
          status.textContent="âš ï¸ "+xhr.status+" "+(xhr.responseText||"Ø®Ø·Ø£");
          if(xhr.status===401) localStorage.removeItem("SUB_KEY");
        }
        processBtn.disabled=false;
      };
      xhr.onerror=()=>{status.textContent="Ø®Ø·Ø£ Ø§ØªØµØ§Ù„";processBtn.disabled=false;};
      xhr.send(fd);
    };

    // ====== Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ======
    showSub.onclick=async()=>{
      const key=await ensureKey(); if(!key) return;
      const device=await getDeviceHash();
      try{
        const res=await fetch("/me",{headers:{"X-KEY":key,"X-DEVICE":device}});
        const data=await res.json();
        if(res.ok){
          subBox.innerHTML=`
            Ù…ÙØªØ§Ø­: ${data.key_masked}<br>
            ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ: ${data.expires}<br>
            Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: ${data.days_left}<br>
            Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø¨Ø·: ${data.bound_to_this_device?"âœ”ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²":"ğŸ”’ Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±"}<br>
            Ø¢Ø®Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù…: ${data.last_used||"â€”"}
          `;
        }else{
          subBox.textContent=data.error||"Ø®Ø·Ø£";
        }
      }catch(e){subBox.textContent="ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„";}
    };
  </script>
</body>
</html>