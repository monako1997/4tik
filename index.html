<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0f1320">
  <title>4TIK PRO âš¡ï¸</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    /* --- Styles for Main Page --- */
    :root{
      --bg:#0a0b12; --ink:#f3f6fb; --muted:#aab6c5; --line:#1d2433;
      --c1:#25F4EE; /* TikTok Cyan */
      --c2:#FE2C55; /* TikTok Pink */
    }
    html { scroll-behavior: smooth; }
    *{ box-sizing: border-box; font-family: 'Cairo', sans-serif; }
    body{
      margin:0; min-height:100vh; display:flex; flex-direction:column; align-items:center; color:var(--ink);
      background-color: var(--bg);
      background-image:
        radial-gradient(ellipse 50vw 30vh at 15% -10%, rgba(37,244,238,.12), transparent 80%),
        radial-gradient(ellipse 60vw 40vh at 110% -20%, rgba(254,44,85,.12), transparent 80%),
        linear-gradient(180deg, #080910 0%, #0a0b12 100%);
      background-attachment: fixed;
    }
    .topbar{
      position:sticky; top:0; width:100%; display:flex; justify-content:center; align-items:center; padding:14px 16px;
      backdrop-filter: saturate(140%) blur(8px);
      background: linear-gradient(180deg, rgba(10,11,18,.75), rgba(10,11,18,0)); z-index:10;
    }
    .brand{
      font-weight:900; font-size:42px; letter-spacing:.6px; margin:0;
      background: linear-gradient(90deg, var(--c2), var(--c1), var(--c2));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow: 0 0 18px rgba(37,244,238,.35), 0 0 18px rgba(254,44,85,.25);
      background-size: 200% auto; animation: shine 3s linear infinite;
      transition: font-size 0.3s ease;
    }
    @keyframes shine { to { background-position:-200% center; } }
    
    /* THIS IS THE FIX */
    .wrap{
      width: min(900px, 94vw);
      padding: 20px 0 160px;
      margin-left: auto;
      margin-right: auto;
    }

    .card{
      background: rgba(15, 19, 32, 0.8);
      border: 1px solid var(--line); border-radius:18px;
      padding: 24px; box-shadow:0 20px 60px rgba(0,0,0,.35); margin-bottom:16px;
      transition: all 0.3s ease;
    }
    .upload{
      position:relative; border-radius:16px; padding:28px; text-align:center; cursor:pointer;
      background:rgba(255,255,255,.02); border:2px dashed #314055;
      overflow:hidden; isolation:isolate; transition: transform 0.3s ease;
    }
    .upload:hover { transform: scale(1.02); }
    .u-title{
      display:inline-block; font-weight:800; font-size:22px; text-transform:uppercase;
      background: linear-gradient(90deg,var(--c1),var(--c2));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      transition: font-size 0.3s ease;
    }
    .hint{ margin-top:6px; color:var(--muted); font-size:14px; }
    .row{
      display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:16px;
    }
    .controls-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      margin-top: 25px;
      margin-bottom: 10px;
    }
    .btn { display: flex; justify-content: center; align-items: center; width: 14rem; overflow: hidden; height: 3.5rem; background-size: 300% 300%; cursor: pointer; backdrop-filter: blur(1rem); border-radius: 5rem; transition: 0.5s; animation: gradient_301 5s ease infinite; border: double 4px transparent; background-image: linear-gradient(#212121, #212121), linear-gradient( 137.48deg, #ffdb3b 10%, #fe53bb 45%, #8f51ea 67%, #0044ff 87%); background-origin: border-box; background-clip: content-box, border-box; }
    .btn .container-stars { position: absolute; z-index: -1; width: 100%; height: 100%; overflow: hidden; transition: 0.5s; backdrop-filter: blur(1rem); border-radius: 5rem; }
    .btn strong { z-index: 2; font-size: 16px; letter-spacing: 2px; color: #ffffff; text-shadow: 0 0 4px white; font-weight: bold; }
    .btn .glow { position: absolute; display: flex; width: 12rem; }
    .btn .circle { width: 100%; height: 30px; filter: blur(2rem); animation: pulse_3011 4s infinite; z-index: -1; }
    .btn .circle:nth-of-type(1) { background: rgba(254, 83, 186, 0.636); }
    .btn .circle:nth-of-type(2) { background: rgba(142, 81, 234, 0.704); }
    .btn:hover .container-stars { z-index: 1; background-color: #212121; }
    .btn:hover { transform: scale(1.1); }
    .btn:active { border: double 4px #fe53bb; background-origin: border-box; background-clip: content-box, border-box; animation: none; }
    .btn:active .circle { background: #fe53bb; }
    .btn .stars { position: relative; background: transparent; width: 200rem; height: 200rem; }
    .btn .stars::after { content: ""; position: absolute; top: -10rem; left: -100rem; width: 100%; height: 100%; animation: animStarRotate 90s linear infinite; background-image: radial-gradient(#ffffff 1px, transparent 1%); background-size: 50px 50px; }
    .btn .stars::before { content: ""; position: absolute; top: 0; left: -50%; width: 170%; height: 500%; animation: animStar 60s linear infinite; background-image: radial-gradient(#ffffff 1px, transparent 1%); background-size: 50px 50px; opacity: 0.5; }
    .btn[disabled] { cursor: not-allowed; filter: grayscale(70%); animation: none; pointer-events: none; }
    .btn[disabled]:hover { transform: scale(1); }
    .btn[disabled] .container-stars, .btn[disabled] .glow { display: none; }
    @keyframes animStar { from { transform: translateY(0); } to { transform: translateY(-135rem); } }
    @keyframes animStarRotate { from { transform: rotate(360deg); } to { transform: rotate(0); } }
    @keyframes gradient_301 { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes pulse_3011 { 0% { transform: scale(0.75); box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(0, 0, 0, 0); } 100% { transform: scale(0.75); box-shadow: 0 0 0 0 rgba(0, 0, 0, 0); } }
    .bar-wrap{ height:14px; background:#0a0f1a; border:1px solid var(--line); border-radius:999px; overflow:hidden; width: 100%; }
    .bar{ height:100%; width:0%; border-radius:999px; background:linear-gradient(90deg,var(--c2),var(--c1)); transition:width .12s; }
    .bar.running{ animation:slide 1.1s linear infinite; background:linear-gradient(90deg,transparent 0%,rgba(255,255,255,.15) 50%,transparent 100%); width:40%; }
    @keyframes slide{ from{margin-inline-start:-40%} to{margin-inline-start:100%} }
    .status{ font-size:14px; color:var(--muted); height: 20px; }
    .footer{ position:fixed; bottom:15px; left:0; right:0; text-align:center; font-size:18px; font-weight:700; color:var(--ink); display:flex; justify-content:center; align-items:center; gap:10px; z-index:20; }
    .heart{ color:var(--c2); font-size:20px; animation:beat 1s infinite; }
    @keyframes beat{ 0%,100%{transform:scale(1)} 50%{transform:scale(1.3)} }
    ul.guide{ padding:0 20px 0 0; margin:0; line-height:1.8; }
    ul.guide li{ margin-bottom:6px; color:var(--muted); }
    @media (max-width: 600px) { .brand { font-size: 34px; } .wrap { padding-bottom: 120px; } .card { padding: 20px; } .upload { padding: 24px; } .u-title { font-size: 18px; } .row { flex-direction: column; align-items: stretch; gap: 14px; } #process { width: 100%; max-width: 300px; } .footer { font-size: 15px; } }

    /* --- Styles for Login Form --- */
    .login-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(10, 11, 18, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(5px);
    }
    .login-overlay .login-card {
        background-image: linear-gradient(163deg, #00ff75 0%, #3700ff 100%);
        border-radius: 22px;
        transition: all 0.3s;
        max-width: 350px;
        width: 90%;
    }
    .login-overlay .login-card:hover { box-shadow: 0px 0px 30px 1px rgba(0, 255, 117, 0.3); }
    .login-overlay .card2 { border-radius: 0; transition: all 0.2s; }
    .login-overlay .card2:hover { transform: scale(0.98); border-radius: 20px; }
    .login-overlay .form { display: flex; flex-direction: column; gap: 10px; padding: 1.5em 2em; background-color: #171717; border-radius: 25px; }
    .login-overlay #heading { text-align: center; margin: 1em 0 2em 0; color: rgb(255, 255, 255); font-size: 1.2em; }
    .login-overlay .field { display: flex; align-items: center; justify-content: center; gap: 0.5em; border-radius: 25px; padding: 0.6em; border: none; outline: none; color: white; background-color: #171717; box-shadow: inset 2px 5px 10px rgb(5, 5, 5); }
    .login-overlay .input-icon { height: 1.3em; width: 1.3em; fill: white; }
    .login-overlay .input-field { background: none; border: none; outline: none; width: 100%; color: #d3d3d3; }
    .login-overlay .input-field:read-only { color: #888; cursor: not-allowed; }
    .login-overlay .btn-container { display: flex; justify-content: center; margin-top: 2.5em; }
    .login-overlay .login-button { padding: 0.8em; width: 100%; border-radius: 5px; border: none; outline: none; transition: 0.4s ease-in-out; background-color: #252525; color: white; font-size: 1em; font-family: 'Cairo', sans-serif; cursor: pointer; }
    .login-overlay .login-button:hover { background-color: #00ff75; color: black; }
    .login-feedback {
        text-align: center;
        color: #FE2C55;
        font-size: 14px;
        height: 20px;
        margin-top: 10px;
    }

  </style>
</head>
<body>

  <div id="login-overlay" class="login-overlay">
    <div class="login-card">
      <div class="card2">
        <form class="form" id="login-form">
          <p id="heading">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</p>
          <div class="field">
            <svg viewBox="0 0 16 16" fill="currentColor" height="16" width="16" xmlns="http://www.w3.org/2000/svg" class="input-icon">
              <path d="M13.106 7.222c0-2.967-2.249-5.032-5.482-5.032-3.35 0-5.646 2.318-5.646 5.702 0 3.493 2.235 5.708 5.762 5.708.862 0 1.689-.123 2.304-.335v-.862c-.43.Û±Û¹Û¹-Û±.Û³ÛµÛ´.Û³Û²Û¸-Û².Û²Û¹.Û³Û²Û¸-Û².Û¹Û²Û¶ Û°-Û´.Û¸Û±Û³-Û±.Û¸Û¸-Û´.Û¸Û±Û³-Û´.Û·Û¹Û¸ Û°-Û².Û¸Û´Û´ Û±.Û¹Û²Û±-Û´.Û¸Û¸Û± Û´.ÛµÛ¹Û´-Û´.Û¸Û¸Û± Û².Û·Û³Ûµ Û° Û´.Û¶Û°Û¸ Û±.Û¶Û¸Û¸ Û´.Û¶Û°Û¸ Û´.Û±ÛµÛ¶ Û° Û±.Û¶Û¸Û²-.ÛµÛµÛ´ Û².Û·Û¶Û¹-Û±.Û´Û±Û¶ Û².Û·Û¶Û¹-.Û´Û¹Û² Û°-.Û·Û·Û²-.Û²Û¸-.Û·Û·Û²-.Û·Û¶V5.206H8.923v.834h-.11c-.266-.595-.881-.964-1.6-.964-1.4 0-2.378 1.162-2.378 2.823 0 1.737.957 2.906 2.379 2.906.8 0 1.415-.39 1.709-1.087h.11c.081.67.703 1.148 1.503 1.148 1.572 0 2.57-1.415 2.57-3.643zm-7.177.704c0-1.197.54-1.907 1.456-1.907.93 0 1.524.738 1.524 1.907S8.308 9.84 7.371 9.84c-.895 0-1.442-.725-1.442-1.914z"></path>
            </svg>
            <input type="text" class="input-field" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" id="username-field" readonly>
          </div>
          <div class="field">
            <svg viewBox="0 0 16 16" fill="currentColor" height="16" width="16" xmlns="http://www.w3.org/2000/svg" class="input-icon">
              <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"></path>
            </svg>
            <input type="text" class="input-field" placeholder="Ù…ÙØªØ§Ø­ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ" id="key-field">
          </div>
          <div class="btn-container">
            <button class="login-button" type="submit">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
          </div>
           <div id="login-feedback" class="login-feedback"></div>
        </form>
      </div>
    </div>
  </div>

  <div id="app-content" style="display: none; width: 100%;">
    <header class="topbar"><h1 class="brand">4TIK PRO âš¡ï¸</h1></header>
    <main class="wrap">
      <section class="card">
        <div id="drop" class="upload">
          <input id="file" type="file" accept="video/*" hidden />
          <div class="u-title">upload video</div>
          <div id="fileInfo" class="hint">Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù‚Ø·Ø¹ Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</div>
        </div>
        <div class="controls-wrap">
          <button type="button" id="process" class="btn" disabled>
            <strong>Ù…Ø¹Ø§Ù„Ø¬Ø©</strong>
            <div class="container-stars"><div class="stars"></div></div>
            <div class="glow"><div class="circle"></div><div class="circle"></div></div>
          </button>
          <div id="status" class="status"></div>
          <div class="bar-wrap"><div id="bar" class="bar"></div></div>
        </div>
      </section>
      <section class="card">
        <div class="row" style="justify-content: center;">
          <button type="button" id="showSub" class="btn">
              <strong>Ø¹Ø±Ø¶ Ø§Ø´ØªØ±Ø§ÙƒÙŠ</strong>
              <div class="container-stars"><div class="stars"></div></div>
              <div class="glow"><div class="circle"></div><div class="circle"></div></div>
            </button>
          <div id="subToast" style="font-size:13px;color:#aab6c5; flex-basis: 100%; text-align: center;"></div>
        </div>
        <div style="margin-top:10px;line-height:1.9">
          <div>Ø§Ù„Ù…ÙØªØ§Ø­: <b id="subKey">â€”</b></div>
          <div>ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ: <b id="subExp">â€”</b></div>
          <div>Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: <b id="subDays">â€”</b></div>
          <div>Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø¨Ø·: <b id="subBind">â€”</b></div>
          <div>Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ù…Ø±Ø¨ÙˆØ·: <b id="subDevice">â€”</b></div>
          <div>Ø¢Ø®Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù…: <b id="subLast">â€”</b></div>
        </div>
      </section>
      <section class="card">
        <h3 style="margin-top:0;color:var(--c1)">â„¹ï¸ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù…Ù‡Ù…Ø©</h3>
        <ul class="guide">
          <li>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø­Ø¬Ù… Ù…Ù„Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: <b>200 Ù…ÙŠÙ‚Ø§</b>.</li>
          <li>Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØªÙ†Ø²ÙŠÙ„Ù‡ØŒ Ø§ÙØªØ­ ØªØ·Ø¨ÙŠÙ‚ <b>TikTok</b> ÙˆØ§Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙƒÙ€<strong>Ø®Ø§Øµ</strong>.</li>
          <li>Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø±ÙØ¹ØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ±Ù‡ Ù…Ù† Ø®Ø§Øµ Ø¥Ù„Ù‰ <strong>Ø¹Ø§Ù…</strong>.</li>
        </ul>
      </section>
    </main>
    <div class="footer">Made by Manal <span class="heart">ğŸ€</span></div>
  </div>

  <script>
    // --- DOM Elements ---
    const drop=document.getElementById('drop'),fileInput=document.getElementById('file'),info=document.getElementById('fileInfo'),
    processBtn=document.getElementById('process'),bar=document.getElementById('bar'),status=document.getElementById('status'),
    showSubBtn=document.getElementById('showSub'),subKey=document.getElementById('subKey'),
    subExp=document.getElementById('subExp'),subDays=document.getElementById('subDays'),subBind=document.getElementById('subBind'),
    subDevice=document.getElementById('subDevice'),subLast=document.getElementById('subLast'),subToast=document.getElementById('subToast');
    const loginOverlay = document.getElementById('login-overlay');
    const loginForm = document.getElementById('login-form');
    const keyField = document.getElementById('key-field');
    const usernameField = document.getElementById('username-field');
    const loginFeedback = document.getElementById('login-feedback');
    const appContent = document.getElementById('app-content');

    // --- Helper Functions ---
    const mb=n=>(n/1024/1024).toFixed(2)+' MB';
    function getDeviceName(){const ua=navigator.userAgent;if(/mobile/i.test(ua)){if(/iphone|ipad|ipod/i.test(ua))return"Apple Device";if(/android/i.test(ua)){const matches=ua.match(/Android\s+[\d\.]+;\s+([\w\s]+)\s+Build/i);if(matches&&matches.length>1)return matches[1];return"Android Device"}}if(/windows/i.test(ua))return"Windows PC";if(/macintosh|mac os x/i.test(ua))return"Mac";return"Unknown Device"}
    async function sha256(text){const enc=new TextEncoder().encode(text),buf=await crypto.subtle.digest('SHA-256',enc);return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('')}
    function canvasFingerprint(){try{const c=document.createElement('canvas');c.width=200;c.height=60;const g=c.getContext('2d');g.textBaseline='top';g.font='16px Arial';g.fillStyle='#f60';g.fillRect(0,0,200,30);g.fillStyle='#069';g.fillText('4TikPro-fp',2,2);g.strokeStyle='#f00';g.arc(100,30,20,0,Math.PI*2);g.stroke();return c.toDataURL()}catch{return'no-canvas'}}
    function webglInfo(){try{const c=document.createElement('canvas'),gl=c.getContext('webgl')||c.getContext('experimental-webgl');if(!gl)return'no-webgl';const dbg=gl.getExtension('WEBGL_debug_renderer_info');return(dbg?gl.getParameter(dbg.UNMASKED_VENDOR_WEBGL):'v?')+'|'+(dbg?gl.getParameter(dbg.UNMASKED_RENDERER_WEBGL):'r?')}catch{return'no-webgl'}}
    async function getDeviceHash(){const seedParts=[navigator.platform||'pf?',(screen.width||0)+'x'+(screen.height||0),window.devicePixelRatio||1,navigator.hardwareConcurrency||'hc?',navigator.deviceMemory||'dm?',navigator.maxTouchPoints||0,Intl.DateTimeFormat().resolvedOptions().timeZone||'tz?',canvasFingerprint(),webglInfo()];return await sha256(seedParts.join('|'))}
    function generateRandomUsername() {
        const adjectives = ["Fast", "Quick", "Silent", "Brave", "Clever", "Super", "Magic"];
        const nouns = ["Lion", "Tiger", "Fox", "Wolf", "Eagle", "User", "Guest"];
        const randomAdj = adjectives[Math.floor(Math.random() * adjectives.length)];
        const randomNoun = nouns[Math.floor(Math.random() * nouns.length)];
        const randomNumber = Math.floor(100 + Math.random() * 900);
        return `${randomAdj}${randomNoun}${randomNumber}`;
    }

    // --- Main App Logic ---
    function showApp() {
        loginOverlay.style.display = 'none';
        appContent.style.display = 'block';
    }

    function showLogin(message = '') {
        usernameField.value = generateRandomUsername();
        loginFeedback.textContent = message;
        loginOverlay.style.display = 'flex';
        appContent.style.display = 'none';
    }
    
    async function refreshSubscriptionBox(isAutoCheck = false) {
      const key = localStorage.getItem('SUB_KEY');
      if (!key) {
        if (!isAutoCheck) showLogin('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ.');
        return false;
      }

      loginFeedback.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚...';

      try {
        const device = await getDeviceHash();
        const headers = { 'X-DEVICE': device, 'X-DEVICE-NAME': getDeviceName() };
        if (key !== "__DEVICE_ONLY__") headers['X-KEY'] = key;

        const res = await fetch('/me', { headers });
        const data = await res.json();

        if (!res.ok) {
          localStorage.removeItem('SUB_KEY');
          subKey.textContent='â€”'; subExp.textContent='â€”'; subDays.textContent='â€”';
          subBind.textContent=data.error||'ØºÙŠØ± Ù…ØªÙˆÙØ±'; subDevice.textContent='â€”'; subLast.textContent='â€”';
          if (!isAutoCheck) showLogin(data.error || 'Ø§Ù„Ù…ÙØªØ§Ø­ ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©');
          return false;
        }

        let displayKey = data.key_masked || 'â€”';
        if (key && key !== "__DEVICE_ONLY__") {
          displayKey = key.substring(0, 4) + "****" + key.slice(-4);
        }
        subKey.textContent = displayKey;
        subExp.textContent = data.expires || 'â€”';
        subDays.textContent = data.days_left ?? 'â€”';
        subBind.textContent = data.bound === false ? 'ØºÙŠØ± Ù…Ø±Ø¨ÙˆØ· Ø¨Ø¹Ø¯' : (data.bound_to_this_device ? 'Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²' : 'Ù…Ø±Ø¨ÙˆØ· Ø¨Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±');
        subDevice.textContent = data.device_name || 'â€”';
        subLast.textContent = data.last_used ? new Date(data.last_used).toLocaleString() : 'â€”';
        
        if (!isAutoCheck) {
            subToast.textContent = 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ';
            setTimeout(() => subToast.textContent = '', 2000);
        }
        
        showApp(); // Show the main application on success
        return true;

      } catch (e) {
        if (!isAutoCheck) {
            subToast.textContent = 'ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ';
            setTimeout(() => subToast.textContent = '', 2000);
        }
        return false;
      }
    }

    // --- Event Listeners ---
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const userKey = keyField.value.trim();
        if (!userKey) {
            loginFeedback.textContent = 'Ø®Ø§Ù†Ø© Ø§Ù„Ù…ÙØªØ§Ø­ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙƒÙˆÙ† ÙØ§Ø±ØºØ©.';
            return;
        }
        localStorage.setItem('SUB_KEY', userKey);
        await refreshSubscriptionBox(false);
    });

    function updateInfo(){const f=fileInput.files[0];status.textContent='';if(!f){info.textContent='Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù‚Ø·Ø¹ Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±';processBtn.disabled=!0;return}
    const MAX_SIZE=209715200;if(f.size>MAX_SIZE){info.textContent=`Ø§Ù„Ù…Ù„Ù: ${f.name}`;status.textContent=`âŒ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ù‹Ø§ (${mb(f.size)}). Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 200 MB.`;processBtn.disabled=!0;fileInput.value='';return}
    info.textContent=`Ø§Ù„Ù…Ù„Ù: ${f.name} â€” ${mb(f.size)}`;processBtn.disabled=!1}
    drop.addEventListener('click',()=>fileInput.click());drop.addEventListener('dragover',e=>e.preventDefault());drop.addEventListener('drop',e=>{e.preventDefault();if(e.dataTransfer.files.length){fileInput.files=e.dataTransfer.files;updateInfo()}});fileInput.addEventListener('change',updateInfo);
    
    processBtn.addEventListener('click',async()=>{const f=fileInput.files[0];if(!f)return;const key=localStorage.getItem('SUB_KEY');if(!key){showLogin('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§.');return}const device=await getDeviceHash();status.textContent='Ø¬Ø§Ø±Ù Ø§Ù„Ø±ÙØ¹â€¦';bar.classList.remove('running');bar.style.width='0%';processBtn.disabled=!0;fileInput.disabled=!0;drop.style.pointerEvents='none';drop.style.opacity='0.5';const fd=new FormData;fd.append('file',f);const xhr=new XMLHttpRequest;xhr.open('POST','/process',!0);xhr.responseType='blob';if(key!=="__DEVICE_ONLY__")xhr.setRequestHeader('X-KEY',key);xhr.setRequestHeader('X-DEVICE',device);xhr.setRequestHeader('X-DEVICE-NAME',getDeviceName());
    xhr.upload.onprogress=e=>{if(e.lengthComputable){bar.style.width=Math.round(e.loaded/e.total*100)+'%'}};xhr.onreadystatechange=()=>{if(xhr.readyState===XMLHttpRequest.HEADERS_RECEIVED){status.textContent='Ø¬Ø§Ø±Ù ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙÙŠØ¯ÙŠÙˆâ€¦';bar.classList.add('running')}};xhr.onload=()=>{bar.classList.remove('running');if(xhr.status===200){status.textContent='ØªÙ…Ù‘Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© â€” ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø¢Ù†';const blob=xhr.response,url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='output.mp4';document.body.appendChild(a);a.click();URL.revokeObjectURL(url);a.remove();setTimeout(()=>{drop.style.pointerEvents='auto';drop.style.opacity='1';fileInput.disabled=!1;fileInput.value='';updateInfo()},800)}else{const reader=new FileReader;reader.onload=()=>{localStorage.removeItem('SUB_KEY');showLogin('Ø§Ù„Ù…ÙØªØ§Ø­ ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØªÙ‡. Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§.');};reader.readAsText(xhr.response);drop.style.pointerEvents='auto';drop.style.opacity='1';fileInput.disabled=!1;updateInfo()}};xhr.onerror=()=>{bar.classList.remove('running');status.textContent='ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„.';drop.style.pointerEvents='auto';drop.style.opacity='1';fileInput.disabled=!1;updateInfo()};xhr.send(fd)});
    
    showSubBtn?.addEventListener('click',()=>refreshSubscriptionBox(false));

    // --- Initial Load ---
    window.addEventListener('load', async () => {
      const keyExists = localStorage.getItem('SUB_KEY');
      if (keyExists) {
        const isValid = await refreshSubscriptionBox(true); // Auto-check silently
        if (!isValid) {
          showLogin('Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø­ÙÙˆØ¸ ØºÙŠØ± ØµØ§Ù„Ø­ØŒ Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§.');
        }
      } else {
        showLogin(); // No key found, show login form
      }
    });

  </script>
</body>
</html>
