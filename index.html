<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>4Tik Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0a0b12;--ink:#f3f6fb;--muted:#aab6c5;--line:#1d2433;--c1:#25F4EE;--c2:#FE2C55;}
    *{box-sizing:border-box;font-family:'Cairo',sans-serif}
    body{margin:0;min-height:100vh;display:flex;flex-direction:column;align-items:center;color:var(--ink);
      background:radial-gradient(800px 400px at 15% -10%, rgba(37,244,238,.12), transparent 60%),
                 radial-gradient(900px 500px at 110% -20%, rgba(254,44,85,.12), transparent 60%),
                 linear-gradient(180deg,#080910 0%, #0a0b12 100%);}
    .topbar{position:sticky;top:0;width:100%;display:flex;justify-content:center;align-items:center;padding:14px 16px;
      backdrop-filter:saturate(140%) blur(6px);background:linear-gradient(180deg, rgba(10,11,18,.65), rgba(10,11,18,0));z-index:10;}
    .brand{font-weight:900;font-size:42px;letter-spacing:.6px;margin:0;background:linear-gradient(90deg,var(--c2),var(--c1),var(--c2));
      -webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 18px rgba(37,244,238,.35),0 0 18px rgba(254,44,85,.25);
      background-size:200% auto;animation:shine 3s linear infinite;}
    @keyframes shine { to { background-position:-200% center; } }
    .wrap{width:min(900px,96vw); padding:20px 16px 160px;}
    .card{background:#0f1320;border:1px solid var(--line);border-radius:16px;padding:22px;box-shadow:0 20px 60px rgba(0,0,0,.35);margin-bottom:14px}
    .upload{position:relative;border-radius:16px;padding:28px;text-align:center;cursor:pointer;background:rgba(255,255,255,.02);
      border:2px dashed #314055;overflow:hidden;isolation:isolate}
    .upload::before{content:"";position:absolute;inset:-2px;z-index:-1;border-radius:18px;
      background:conic-gradient(from 0deg,var(--c1),var(--c2),var(--c1));filter:blur(14px);opacity:.45}
    .u-title{display:inline-block;font-weight:800;font-size:22px;text-transform:uppercase;background:linear-gradient(90deg,var(--c1),var(--c2));
      -webkit-background-clip:text;background-clip:text;color:transparent}
    .hint{margin-top:6px;color:var(--muted);font-size:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:14px}
    button{padding:12px 22px;border:0;border-radius:12px;font-weight:700;cursor:pointer;font-size:16px;
      background:linear-gradient(90deg,var(--c2),var(--c1));color:#0a0b12;box-shadow:0 8px 24px rgba(37,244,238,.18),0 8px 24px rgba(254,44,85,.16)}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .bar-wrap{height:14px;background:#0a0f1a;border:1px solid var(--line);border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0%;border-radius:999px;background:linear-gradient(90deg,var(--c2),var(--c1));transition:width .12s}
    .bar.running{animation:slide 1.1s linear infinite;background:linear-gradient(90deg,transparent 0%,rgba(255,255,255,.15) 50%,transparent 100%);width:40%}
    @keyframes slide{from{margin-inline-start:-40%}to{margin-inline-start:100%}}
    .status{font-size:14px;color:var(--muted)}
    .footer{position:fixed;bottom:15px;left:0;right:0;text-align:center;font-size:18px;font-weight:700;color:var(--ink);
      display:flex;justify-content:center;align-items:center;gap:10px;z-index:20}
    .heart{color:var(--c2);font-size:20px;animation:beat 1s infinite}
    @keyframes beat{0%,20%,40%,60%,80%,100%{transform:scale(1)}10%,30%,50%,70%,90%{transform:scale(1.3)}}
    ul.guide{padding:0 20px;margin:0;line-height:1.8}
    ul.guide li{margin-bottom:6px;color:var(--muted)}

    /* ==== Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ==== */
    .modal {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.7);
      display: none; justify-content: center; align-items: center;
      z-index: 100;
    }
    .modal-content {
      background: #0f1320;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      width: 90%; max-width: 400px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
    }
    .modal-content h2 {margin-top:0; color: var(--c1);}
    .modal-content input {
      width: 100%; padding: 12px; margin: 15px 0;
      border-radius: 8px; border: 1px solid #314055;
      font-size: 16px; text-align: center;
    }
    .modal-content button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      background: linear-gradient(90deg,var(--c2),var(--c1));
      color: #0a0b12;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header class="topbar"><h1 class="brand">4Tik Pro</h1></header>

  <main class="wrap">
    <!-- Ø±ÙØ¹ -->
    <section class="card">
      <div id="drop" class="upload">
        <input id="file" type="file" accept="video/*" hidden />
        <div class="u-title">upload video</div>
        <div id="fileInfo" class="hint">Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù‚Ø·Ø¹ Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</div>
      </div>
      <div class="row">
        <button id="process" disabled>Ù…Ø¹Ø§Ù„Ø¬Ø©</button>
        <div id="status" class="status" style="margin-inline-start:auto"></div>
      </div>
      <div class="bar-wrap" style="margin-top:12px"><div id="bar" class="bar"></div></div>
    </section>

    <!-- Ø§Ø´ØªØ±Ø§Ùƒ -->
    <section class="card">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <button id="showSub">Ø¹Ø±Ø¶ Ø§Ø´ØªØ±Ø§ÙƒÙŠ</button>
        <button id="copyKey" style="background:#fff;color:#0a0b12">Ù†Ø³Ø® Ù…ÙØªØ§Ø­ÙŠ</button>
        <div id="subToast" style="font-size:13px;color:#aab6c5"></div>
      </div>
      <div style="margin-top:10px;line-height:1.9">
        <div>Ø§Ù„Ù…ÙØªØ§Ø­: <b id="subKey">â€”</b></div>
        <div>ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ: <b id="subExp">â€”</b></div>
        <div>Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: <b id="subDays">â€”</b></div>
        <div>Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø¨Ø·: <b id="subBind">â€”</b></div>
        <div>Ø¢Ø®Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù…: <b id="subLast">â€”</b></div>
      </div>
    </section>
  </main>

  <div class="footer">Made by Manal <span class="heart">â¤</span></div>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ -->
  <div id="welcomeModal" class="modal">
    <div class="modal-content">
      <h2>ğŸ‰ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ 4Tik Pro</h2>
      <p>Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©:</p>
      <input id="keyInput" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…ÙØªØ§Ø­ Ù‡Ù†Ø§" />
      <button id="loginBtn">Login</button>
    </div>
  </div>

  <script>
    const drop = document.getElementById('drop');
    const fileInput = document.getElementById('file');
    const info = document.getElementById('fileInfo');
    const processBtn = document.getElementById('process');
    const bar = document.getElementById('bar');
    const status = document.getElementById('status');
    const showSubBtn = document.getElementById('showSub');
    const copyKeyBtn = document.getElementById('copyKey');
    const subKey = document.getElementById('subKey');
    const subExp = document.getElementById('subExp');
    const subDays = document.getElementById('subDays');
    const subBind = document.getElementById('subBind');
    const subLast = document.getElementById('subLast');
    const subToast = document.getElementById('subToast');
    const welcomeModal = document.getElementById("welcomeModal");
    const keyInput = document.getElementById("keyInput");
    const loginBtn = document.getElementById("loginBtn");

    const mb = n => (n/1024/1024).toFixed(2)+' MB';

    // ======= Ø¨ØµÙ…Ø© Ø§Ù„Ø¬Ù‡Ø§Ø² =======
    async function sha256(text){
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
    }
    function canvasFingerprint(){
      try{
        const c=document.createElement("canvas"); c.width=200;c.height=60;
        const g=c.getContext("2d"); g.textBaseline="top";
        g.font="16px Arial"; g.fillStyle="#f60"; g.fillRect(0,0,200,30);
        g.fillStyle="#069"; g.fillText("4TikPro-fp",2,2);
        g.strokeStyle="#f00"; g.arc(100,30,20,0,Math.PI*2); g.stroke();
        return c.toDataURL();
      }catch{return "no-canvas";}
    }
    function webglInfo(){
      try{
        const c=document.createElement("canvas");
        const gl=c.getContext("webgl")||c.getContext("experimental-webgl");
        if(!gl) return "no-webgl";
        const dbg=gl.getExtension("WEBGL_debug_renderer_info");
        const vendor=dbg?gl.getParameter(dbg.UNMASKED_VENDOR_WEBGL):"v?";
        const renderer=dbg?gl.getParameter(dbg.UNMASKED_RENDERER_WEBGL):"r?";
        return vendor+"|"+renderer;
      }catch{return "no-webgl";}
    }
    async function getDeviceHash(){
      const parts=[
        navigator.platform||"pf?",
        (screen.width||0)+"x"+(screen.height||0),
        window.devicePixelRatio||1,
        navigator.hardwareConcurrency||"hc?",
        navigator.deviceMemory||"dm?",
        navigator.maxTouchPoints||0,
        Intl.DateTimeFormat().resolvedOptions().timeZone||"tz?",
        canvasFingerprint(),
        webglInfo()
      ];
      return await sha256(parts.join("|"));
    }

    // ======= ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù =======
    function updateInfo(){
      const f=fileInput.files[0];
      status.textContent="";
      if(!f){ info.textContent="Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù‚Ø·Ø¹ Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±"; processBtn.disabled=true; return; }
      info.textContent=`Ø§Ù„Ù…Ù„Ù: ${f.name} â€” ${mb(f.size)}`;
      processBtn.disabled=false;
    }
    drop.addEventListener("click",()=>fileInput.click());
    drop.addEventListener("dragover",e=>e.preventDefault());
    drop.addEventListener("drop",e=>{e.preventDefault(); if(e.dataTransfer.files.length){ fileInput.files=e.dataTransfer.files; updateInfo(); }});
    fileInput.addEventListener("change",updateInfo);

    // ======= Ù…Ø¹Ø§Ù„Ø¬Ø© =======
    async function getKey(){ return localStorage.getItem("SUB_KEY"); }
    processBtn.addEventListener("click",async()=>{
      const f=fileInput.files[0]; if(!f) return;
      const key=await getKey(); if(!key){welcomeModal.style.display="flex"; return;}
      const device=await getDeviceHash();

      status.textContent="Ø¬Ø§Ø±Ù Ø§Ù„Ø±ÙØ¹â€¦";
      bar.classList.remove("running"); bar.style.width="0%";
      processBtn.disabled=true; fileInput.disabled=true; drop.style.pointerEvents="none"; drop.style.opacity="0.5";

      const fd=new FormData(); fd.append("file",f);
      const xhr=new XMLHttpRequest();
      xhr.open("POST","/process",true);
      xhr.responseType="blob";
      xhr.setRequestHeader("X-KEY",key);
      xhr.setRequestHeader("X-DEVICE",device);

      xhr.upload.onprogress=e=>{if(e.lengthComputable){bar.style.width=Math.round((e.loaded/e.total)*100)+"%";}};
      xhr.onreadystatechange=()=>{if(xhr.readyState===XMLHttpRequest.HEADERS_RECEIVED){status.textContent="Ø¬Ø§Ø±Ù ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙÙŠØ¯ÙŠÙˆâ€¦"; bar.classList.add("running");}};

      xhr.onload=()=>{
        bar.classList.remove("running");
        if(xhr.status===200){
          status.textContent="ØªÙ…Ù‘Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© â€” ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø¢Ù†";
          const blob=xhr.response, url=URL.createObjectURL(blob);
          const a=document.createElement("a"); a.href=url; a.download="output.mp4"; document.body.appendChild(a); a.click();
          URL.revokeObjectURL(url); a.remove();
          setTimeout(()=>{drop.style.pointerEvents="auto"; drop.style.opacity="1"; fileInput.disabled=false; fileInput.value=""; updateInfo();},800);
        }else{
          const reader=new FileReader();
          reader.onload=()=>{status.textContent=reader.result||"Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§.";};
          reader.readAsText(xhr.response);
          drop.style.pointerEvents="auto"; drop.style.opacity="1"; fileInput.disabled=false; updateInfo();
          if(xhr.status===401) localStorage.removeItem("SUB_KEY");
        }
      };
      xhr.onerror=()=>{bar.classList.remove("running"); status.textContent="ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„."; drop.style.pointerEvents="auto"; drop.style.opacity="1"; fileInput.disabled=false; updateInfo();};
      xhr.send(fd);
    });

    // ======= ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ =======
    async function refreshSubscriptionBox(){
      try{
        const key=localStorage.getItem("SUB_KEY");
        const device=await getDeviceHash();
        if(!key && !device) return;
        const headers={ "X-KEY":key||"", "X-DEVICE":device };
        const res=await fetch("/me",{headers});
        const data=await res.json();

        if(!res.ok){
          subKey.textContent="â€”"; subExp.textContent="â€”"; subDays.textContent="â€”";
          subBind.textContent=data.error||"ØºÙŠØ± Ù…ØªÙˆÙØ±"; subLast.textContent="â€”"; return;
        }

        subKey.textContent=(key?key.substring(0,4)+"****":"â€”");
        subExp.textContent=data.expires||"â€”";
        if(data.expires){
          const d1=new Date(data.expires); const d2=new Date();
          const diff=Math.ceil((d1-d2)/(1000*60*60*24));
          subDays.textContent=diff>=0?diff:0;
        }else subDays.textContent="â€”";
        subBind.textContent=data.bound_to_this_device?"Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²":"Ù…Ø±Ø¨ÙˆØ· Ø¨Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±";
        subLast.textContent=data.last_used||"â€”";
        subToast.textContent="âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ";
        setTimeout(()=>subToast.textContent="",2000);
      }catch{ subToast.textContent="ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ"; setTimeout(()=>subToast.textContent="",2000); }
    }
    showSubBtn?.addEventListener("click",refreshSubscriptionBox);
    copyKeyBtn?.addEventListener("click",async()=>{
      const key=localStorage.getItem("SUB_KEY");
      if(!key){alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙØªØ§Ø­ Ù…Ø­ÙÙˆØ¸ Ø¨Ø¹Ø¯.");return;}
      try{await navigator.clipboard.writeText(key); subToast.textContent="ğŸ“‹ ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…ÙØªØ§Ø­"; setTimeout(()=>subToast.textContent="",2000);}
      catch{ subToast.textContent="ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø®ØŒ Ø§Ù†Ø³Ø®Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹."; setTimeout(()=>subToast.textContent="",2000);}
    });

    // ======= ØªØ­Ù‚Ù‚ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© =======
    window.addEventListener("load", async ()=>{
      const device=await getDeviceHash();
      try{
        const res=await fetch("/check",{headers:{"X-DEVICE":device}});
        if(res.ok){
          welcomeModal.style